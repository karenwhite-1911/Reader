# Reader 项目编译问题解决方案

## 问题：无法解析的外部符号 __imp_calloc

### 错误信息
```
libmobid.lib(structure.obj) : error LNK2001: 无法解析的外部符号 __imp_calloc
libmobid.lib(index.obj) : error LNK2001: 无法解析的外部符号 __imp_calloc
...
D:\local\Reader\x64\Debug\Reader.exe : fatal error LNK1120: 1 个无法解析的外部命令
```

### 根本原因

这个错误是由于**运行时库（CRT）链接方式不匹配**导致的：

1. **libmobi 库的编译方式**
   - libmobid.lib 是用**动态链接的 CRT** 编译的（/MDd 或 /MD）
   - 它期望从 msvcrt.dll 或 msvcrtd.dll 中导入 calloc、malloc、free 等函数
   - 这些函数的符号形式为 `__imp_calloc`（导入符号）

2. **项目的编译方式**
   - 原项目配置使用**静态链接的 CRT**（/MTd 或 /MT）
   - 静态链接会将 CRT 代码直接嵌入到 exe 中
   - 静态链接的符号形式为 `calloc`（直接符号，不是导入）

3. **冲突**
   - libmobid.lib 需要 `__imp_calloc`（从 DLL 导入）
   - 但项目只提供了 `calloc`（静态链接）
   - 链接器找不到 `__imp_calloc`，导致链接失败

### 解决方案

**方案 1：修改项目使用动态 CRT（推荐）✅**

将项目的运行时库改为动态链接，与 libmobi 保持一致。

**修改位置：** Reader.vcxproj

```xml
<!-- Debug x64 配置 -->
<RuntimeLibrary>MultiThreadedDebugDLL</RuntimeLibrary>  <!-- 原来是 MultiThreadedDebug -->

<!-- Release x64 配置 -->
<RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>  <!-- 原来是 MultiThreaded -->

<!-- Debug Win32 配置 -->
<RuntimeLibrary>MultiThreadedDebugDLL</RuntimeLibrary>

<!-- Release Win32 配置 -->
<RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>
```

**优点：**
- 简单快速，只需修改项目配置
- 生成的 exe 文件较小
- 与第三方库兼容性好

**缺点：**
- 需要分发 VC++ 运行时 DLL（vcruntime140.dll 等）
- 或者要求用户安装 VC++ Redistributable

---

**方案 2：重新编译 libmobi 使用静态 CRT**

如果你有 libmobi 的源码，可以重新编译它使用静态 CRT。

**步骤：**
1. 获取 libmobi 源码
2. 修改编译配置，将运行时库改为 `/MT`（Release）或 `/MTd`（Debug）
3. 重新编译生成 libmobi.lib 和 libmobid.lib
4. 替换 opensrc/libmobi/lib/ 下的库文件

**优点：**
- 生成独立的 exe，不需要额外的 DLL
- 适合绿色软件发布

**缺点：**
- 需要重新编译第三方库
- 生成的 exe 文件较大
- 需要确保所有第三方库都使用相同的 CRT

---

**方案 3：使用 /NODEFAULTLIB 和手动链接**

强制链接器忽略默认库，手动指定需要的库。

**不推荐：** 这种方式容易出现其他问题，维护困难。

## 其他相关警告

### LNK4098: 默认库冲突
```
LIBCMTD.lib(initializers.obj) : warning LNK4098: 默认库"msvcrtd.lib"与其他库的使用冲突
```

**原因：** 混用了静态 CRT (LIBCMTD.lib) 和动态 CRT (msvcrtd.lib)

**解决：** 使用方案 1 统一使用动态 CRT 后，此警告会消失。

### LNK4217/LNK4286: 符号导入警告
```
LINK : warning LNK4217: 符号"fclose"已由"libmobid.lib"导入
LINK : warning LNK4286: 符号"free"已由"libmobid.lib"导入
```

**原因：** libmobi 库期望从 DLL 导入这些函数，但项目使用静态链接

**解决：** 使用方案 1 后，这些警告也会消失。

### LNK4099: 未找到 PDB
```
libmobid.lib(read.obj) : warning LNK4099: 未找到 PDB"libmobi.pdb"
```

**说明：** 第三方库没有提供调试符号文件

**影响：** 不影响编译和运行，只是无法调试第三方库内部代码

**处理：** 可以忽略，或者联系库作者获取 PDB 文件

## 运行时库对照表

| 配置 | 编译选项 | 库文件 | DLL 依赖 | 说明 |
|------|---------|--------|----------|------|
| Debug 静态 | /MTd | LIBCMTD.lib | 无 | 调试版静态链接 |
| Release 静态 | /MT | LIBCMT.lib | 无 | 发布版静态链接 |
| Debug 动态 | /MDd | msvcrtd.lib | msvcr140d.dll | 调试版动态链接 |
| Release 动态 | /MD | msvcrt.lib | msvcr140.dll | 发布版动态链接 |

## 验证修改

修改后重新编译，应该看到：
1. ✅ 链接成功，没有 LNK2001 错误
2. ✅ LNK4098 警告消失
3. ✅ LNK4217/LNK4286 警告消失
4. ⚠️ LNK4099 警告仍然存在（可忽略）

## 发布注意事项

使用动态 CRT (/MD) 编译后，发布时需要：

1. **包含 VC++ 运行时 DLL**
   - vcruntime140.dll
   - msvcp140.dll
   - 可以从 `C:\Windows\System32\` 复制

2. **或者要求用户安装 VC++ Redistributable**
   - 下载地址：https://aka.ms/vs/17/release/vc_redist.x64.exe
   - 在安装程序中包含此安装包

3. **或者使用静态链接**
   - 重新编译所有第三方库使用 /MT
   - 生成独立的 exe 文件

## 总结

**推荐方案：** 使用动态 CRT (/MD 或 /MDd)

**原因：**
- 与第三方库兼容
- 修改简单
- 符合现代 Windows 应用开发习惯
- 大多数用户系统已安装 VC++ 运行时

**已完成的修改：**
- ✅ Debug|Win32: MultiThreadedDebug → MultiThreadedDebugDLL
- ✅ Release|Win32: MultiThreaded → MultiThreadedDLL
- ✅ Debug|x64: MultiThreadedDebug → MultiThreadedDebugDLL
- ✅ Release|x64: MultiThreaded → MultiThreadedDLL

现在可以重新编译项目了！
