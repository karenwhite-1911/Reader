# Reader 项目说明

## 项目概述
Reader 是一个 Win32 平台的 txt/epub/mobi/在线小说阅读器，使用 C++ 和 Win32 API 开发。

## 项目结构

```
Reader/
├── opensrc/                    # 第三方开源库
│   ├── cjson/                 # JSON 解析库
│   ├── miniz/                 # ZIP 压缩库（替代 zlib）
│   ├── zlib/                  # ZIP 压缩库
│   ├── libxml2/               # XML 解析库（用于 EPUB）
│   ├── libmobi/               # MOBI 格式解析库
│   ├── libhttps/              # HTTPS 网络库
│   ├── wolfssl/               # SSL/TLS 库（替代 openssl）
│   └── openssl/               # SSL/TLS 库
│
├── Reader/                     # 主程序源码
│   ├── Reader.cpp             # 主程序入口
│   ├── Book.cpp/h             # 书籍基类
│   ├── TextBook.cpp/h         # TXT 格式书籍
│   ├── EpubBook.cpp/h         # EPUB 格式书籍
│   ├── MobiBook.cpp/h         # MOBI 格式书籍
│   ├── OnlineBook.cpp/h       # 在线小说
│   ├── Page.cpp/h             # 页面渲染
│   ├── Cache.cpp/h            # 缓存管理
│   ├── Utils.cpp/h            # 工具函数
│   ├── HtmlParser.cpp/h       # HTML 解析
│   ├── Jsondata.cpp/h         # JSON 数据处理
│   ├── OnlineDlg.cpp/h        # 在线小说对话框
│   ├── BooksourceDlg.cpp/h    # 书源管理对话框
│   ├── DisplaySet.cpp/h       # 显示设置
│   ├── Keyset.cpp/h           # 快捷键设置
│   ├── Advset.cpp/h           # 高级设置
│   ├── Upgrade.cpp/h          # 版本更新
│   └── ...
│
├── doc/                        # 文档
│   └── bs.md                  # 书源配置说明
│
├── tool/                       # 工具
│   ├── 7z.exe                 # 压缩工具
│   ├── ol2txt.exe             # 在线小说转文本
│   └── repstr.exe             # 字符串替换
│
├── bs.json                     # 书源配置文件
├── version.json                # 版本信息
├── Reader.sln                  # VS 解决方案
└── README.md                   # 项目说明
```

## 编译环境
- Visual Studio 2022
- Windows SDK 10.0
- 平台工具集：v143
- 支持平台：Win32 (x86) 和 x64

## 编译配置

### 预处理器定义
- `_CRT_SECURE_NO_WARNINGS` - 禁用 CRT 安全警告
- `_CRT_NON_CONFORMING_SWPRINTFS` - 兼容旧版 swprintf
- `CJSON_HIDE_SYMBOLS` - 隐藏 cJSON 符号
- `ZLIB_WINAPI` - 使用 Windows API 版本的 zlib
- `LIBXML_STATIC` - 静态链接 libxml2
- `LIBHTTPS_STATIC` - 静态链接 libhttps
- `ENABLE_NETWORK` - 启用网络功能

### 运行时库
- Debug: MultiThreadedDebugDLL (/MDd)
- Release: MultiThreadedDLL (/MD)

**注意：** 必须使用动态链接的运行时库（/MD 或 /MDd），因为 libmobi 库是用动态 CRT 编译的。

## 主要功能
1. **多格式支持**
   - TXT 文本文件（支持多种编码）
   - EPUB 电子书
   - MOBI 电子书
   - 在线小说

2. **阅读功能**
   - 自动章节识别
   - 书签管理
   - 阅读进度保存
   - 自动翻页
   - 全屏模式

3. **显示设置**
   - 字体、字号、颜色自定义
   - 背景图片/颜色
   - 行距、段距、字符间距
   - 窗口透明度
   - 取色器

4. **在线小说**
   - 书源配置
   - 小说搜索
   - 章节缓存
   - 自动更新

5. **其他功能**
   - 快捷键自定义
   - 热键支持
   - 最小化托盘
   - 版本更新检查

## 常见编译问题

### 1. 无法解析的外部符号 __imp_calloc
**原因：** 运行时库链接不匹配。libmobi 库使用动态 CRT (/MD)，而项目使用静态 CRT (/MT)。

**解决方案：** 将项目的运行时库改为动态链接（/MD 或 /MDd）。

### 2. 默认库冲突
**原因：** 混用了静态和动态运行时库。

**解决方案：** 确保所有库和项目使用相同的运行时库类型。

### 3. 缺少 PDB 文件警告
**说明：** 第三方库没有提供调试符号文件，不影响编译，可以忽略。

## 依赖库说明

### libmobi
- 用于解析 MOBI/AZW 格式电子书
- 编译方式：动态 CRT (/MD)
- 位置：opensrc/libmobi/

### libxml2
- 用于解析 EPUB 中的 XML/HTML
- 编译方式：静态链接
- 位置：opensrc/libxml2/

### wolfssl
- 提供 SSL/TLS 支持（替代 openssl）
- 用于 HTTPS 网络请求
- 位置：opensrc/wolfssl/

### miniz
- ZIP 压缩/解压（用于 EPUB）
- 轻量级，替代 zlib
- 位置：opensrc/miniz/

### cJSON
- JSON 解析（用于书源配置）
- 位置：opensrc/cjson/

## 编译步骤

1. 打开 `Reader.sln`
2. 选择配置（Debug/Release）和平台（x86/x64）
3. 确保运行时库设置为 `/MD` 或 `/MDd`
4. 生成解决方案

## 发布版本
- 正式版需要使用 Release 配置
- 建议使用 7z 压缩打包
- 包含必要的 DLL 文件（如果使用动态链接）

## 许可证
- 个人开发，开源免费
- 严禁商业用途
- 严禁非法用途
